
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>First steps with Leaspy &#8212; Disease Progression Modelling</title>
    
  <link rel="stylesheet" href="../../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom_css.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/custom_js.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Advanced Leaspy Utilisation" href="TP3_advanced_leaspy.html" />
    <link rel="prev" title="Linear Mixed-effects Models" href="TP1_LMM.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../../index.html">
  
  
  <h1 class="site-logo" id="site-title">Disease Progression Modelling</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../main.html">
   Disease Progression Modelling
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Get started
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../DPM/introduction.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Materials
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../materials/introduction.html">
   Introduction to Disease Progression Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../materials/event_based_model.html">
   Event Based model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../materials/leaspy.html">
   Leaspy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../materials/non_parametric_DPM.html">
   Non-Parametric Disease Progression Model
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Notebooks
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../notebooks.html">
   Notebooks
  </a>
 </li>
 <li class="toctree-l1 current active collapsible-parent">
  <a class="reference internal" href="leaspy.html">
   Leaspy
  </a>
  <ul class="current collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="TP1_LMM.html">
     TP1 - Linear Mixed Effect Models
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     TP2 - Get ready with Leaspy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="TP3_advanced_leaspy.html">
     TP3 - Leaspy advanced
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Conferences
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../conferences/ISBI.html">
   ISBI 2021
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../other/contributors.html">
   Contributors
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../../_sources/pages/notebooks/leaspy/TP2_leaspy_beginner.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Disease-Progression-Modelling/disease-progression-modelling.github.io/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Disease-Progression-Modelling/disease-progression-modelling.github.io//issues/new?title=Issue%20on%20page%20%2Fpages/notebooks/leaspy/TP2_leaspy_beginner.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/Disease-Progression-Modelling/disease-progression-modelling.github.io/edit/master/pages/notebooks/leaspy/TP2_leaspy_beginner.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Disease-Progression-Modelling/disease-progression-modelling.github.io/master?urlpath=tree/pages/notebooks/leaspy/TP2_leaspy_beginner.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/Disease-Progression-Modelling/disease-progression-modelling.github.io/blob/master/pages/notebooks/leaspy/TP2_leaspy_beginner.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../../../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#objectives">
   Objectives :
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-set-up">
   The set-up
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-i-data">
   Part I: Data
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#leaspy-s-data-container">
     Leaspyâ€™s
     <code class="docutils literal notranslate">
      <span class="pre">
       Data
      </span>
     </code>
     container
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-ii-instantiate-a-leaspy-object">
   Part II : Instantiate a
   <code class="docutils literal notranslate">
    <span class="pre">
     Leaspy
    </span>
   </code>
   object
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-iii-choose-your-algorithms">
   Part III : Choose your algorithms
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-iv-fit-your-model">
   Part IV : Fit your model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-v-personalize-the-model-to-individual-data">
   Part V : Personalize the model to individual data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-vi-impute-missing-values-predict-individual-trajectories">
   Part VI : Impute missing values &amp; predict individual trajectories
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-vii-leaspy-application-cofactor-analysis">
   Part VII : Leaspy application - Cofactor analysis
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#part-viii-data-simulation">
   Part VIII : Data Simulation
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="first-steps-with-leaspy">
<h1>First steps with Leaspy<a class="headerlink" href="#first-steps-with-leaspy" title="Permalink to this headline">Â¶</a></h1>
<p>Welcome for the second practical session of the day!</p>
<div class="section" id="objectives">
<h2>Objectives :<a class="headerlink" href="#objectives" title="Permalink to this headline">Â¶</a></h2>
<ul class="simple">
<li><p>Learn to use Leaspy methods</p></li>
</ul>
</div>
<div class="section" id="the-set-up">
<h2>The set-up<a class="headerlink" href="#the-set-up" title="Permalink to this headline">Â¶</a></h2>
<p>As before, if you have followed the <a class="reference external" href="https://gitlab.com/icm-institute/aramislab/disease-course-mapping-solutions">installation details</a> carefully, you should</p>
<ul class="simple">
<li><p>be running this notebook in the <code class="docutils literal notranslate"><span class="pre">leaspy_tutorial</span></code> virtual environment</p></li>
<li><p>having all the needed packages already installed</p></li>
</ul>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 1 ğŸ’¬</span> Run the following command lines</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># import main classes from Leaspy package</span>
<span class="kn">from</span> <span class="nn">leaspy</span> <span class="kn">import</span> <span class="n">Leaspy</span><span class="p">,</span> <span class="n">Data</span><span class="p">,</span> <span class="n">AlgorithmSettings</span><span class="p">,</span> <span class="n">IndividualParameters</span><span class="c1">#, __watermark__</span>

<span class="c1"># Watermark trace with all packages versions</span>
<span class="c1">#print(&quot;\n&quot;.join([f&#39;{pkg}: {pkg_version}&#39; for pkg, pkg_version in __watermark__.items()]))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="part-i-data">
<h2>Part I: Data<a class="headerlink" href="#part-i-data" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Data that can be used as a leaspy input should have the following format.</p>
<p>This result in multiple rows per subject. The input format <strong><em>MUST</em></strong> follow the following rules:</p>
<ul class="simple">
<li><p>A column named <code class="docutils literal notranslate"><span class="pre">ID</span></code>: corresponds to the subject indices</p></li>
<li><p>A columns named <code class="docutils literal notranslate"><span class="pre">TIME</span></code>: corresponds to the subjectâ€™s age at the corresponding visit</p></li>
<li><p>One column per feature</p></li>
<li><p>Each row is a visit, therefore the concatenation of the subject ID, the patient age at which the corresponding visit occured, and then the feature values</p></li>
</ul>
<p>Concerning the featuresâ€™ values, as we are using a logistic model, they <strong><em>MUST</em></strong>:</p>
<ul class="simple">
<li><p>Be between 0 and 1</p></li>
<li><p>In average increase with time for each subject (normal states correspond to values near 0 and pathological states to values near 1)</p></li>
</ul>
<p>Moreover, to calibrate the progression model, we highly recommend to keep subjects that have been seen at least two times. You probably noticed that there are NaN: do not worry, Leaspy can handle them ;)</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 2 ğŸ’¬</span> <strong>Run the following lines to load the data.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s2">&quot;data/TP2_leaspy_beginner/&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;simulated_data-corrected.csv&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span><span class="s2">&quot;TIME&quot;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>MDS1_total</th>
      <th>MDS2_total</th>
      <th>MDS3_off_total</th>
      <th>SCOPA_total</th>
      <th>MOCA_total</th>
      <th>REM_total</th>
      <th>PUTAMEN_R</th>
      <th>PUTAMEN_L</th>
      <th>CAUDATE_R</th>
      <th>CAUDATE_L</th>
      <th>PUTAMEN</th>
    </tr>
    <tr>
      <th>ID</th>
      <th>TIME</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">GS-001</th>
      <th>71.354607</th>
      <td>0.112301</td>
      <td>0.122472</td>
      <td>0.171078</td>
      <td>0.160001</td>
      <td>0.275257</td>
      <td>0.492485</td>
      <td>0.780210</td>
      <td>0.676774</td>
      <td>0.622611</td>
      <td>0.494641</td>
      <td>0.728492</td>
    </tr>
    <tr>
      <th>71.554604</th>
      <td>0.140880</td>
      <td>0.109504</td>
      <td>0.118693</td>
      <td>0.135852</td>
      <td>0.380934</td>
      <td>0.577203</td>
      <td>0.751444</td>
      <td>0.719796</td>
      <td>0.618434</td>
      <td>0.530978</td>
      <td>0.735620</td>
    </tr>
    <tr>
      <th>72.054604</th>
      <td>0.225499</td>
      <td>0.270502</td>
      <td>0.061310</td>
      <td>0.211134</td>
      <td>0.351172</td>
      <td>0.835828</td>
      <td>0.823315</td>
      <td>0.691504</td>
      <td>0.717099</td>
      <td>0.576978</td>
      <td>0.757409</td>
    </tr>
    <tr>
      <th>73.054604</th>
      <td>0.132519</td>
      <td>0.253548</td>
      <td>0.258786</td>
      <td>0.245323</td>
      <td>0.377842</td>
      <td>0.566496</td>
      <td>0.813593</td>
      <td>0.787914</td>
      <td>0.770048</td>
      <td>0.709486</td>
      <td>0.800754</td>
    </tr>
    <tr>
      <th>73.554604</th>
      <td>0.278923</td>
      <td>0.321920</td>
      <td>0.143350</td>
      <td>0.223102</td>
      <td>0.292768</td>
      <td>0.741811</td>
      <td>0.888792</td>
      <td>0.852720</td>
      <td>0.797368</td>
      <td>0.715465</td>
      <td>0.870756</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 3 ğŸ’¬</span> Does the data set seem to have the good format?</p>
<p>Your answer: â€¦</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 4 ğŸ’¬</span> How many patients are there in the dataset?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To complete</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ #</span>
<span class="c1"># â€“â€“â€“â€“ Answer â€“â€“â€“â€“ #</span>
<span class="c1"># â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ #</span>

<span class="n">n_subjects</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n_subjects</span><span class="si">}</span><span class="s1"> subjects in the dataset.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>200 subjects in the dataset.
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 5 ğŸ’¬</span> Create a training test that contains the first 160 patients and a testing set the rest. Each set will only contain the following features:</p>
<ul class="simple">
<li><p>MDS1_total</p></li>
<li><p>MDS2_total</p></li>
<li><p>MDS3_off_total</p></li>
</ul>
<p>Help : Be careful, one patient is not one line â€¦</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To complete</span>

<span class="n">df_train</span> <span class="o">=</span> <span class="c1">######################</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="c1">######################</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ #</span>
<span class="c1"># â€“â€“â€“â€“ Answer â€“â€“â€“â€“ #</span>
<span class="c1"># â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ #</span>

<span class="n">df_train</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="s1">&#39;GS-160&#39;</span><span class="p">][[</span><span class="s2">&quot;MDS1_total&quot;</span><span class="p">,</span> <span class="s2">&quot;MDS2_total&quot;</span><span class="p">,</span> <span class="s2">&quot;MDS3_off_total&quot;</span><span class="p">]]</span>
<span class="n">df_test</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;GS-161&#39;</span><span class="p">:][[</span><span class="s2">&quot;MDS1_total&quot;</span><span class="p">,</span> <span class="s2">&quot;MDS2_total&quot;</span><span class="p">,</span> <span class="s2">&quot;MDS3_off_total&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="leaspy-s-data-container">
<h3>Leaspyâ€™s <code class="docutils literal notranslate"><span class="pre">Data</span></code> container<a class="headerlink" href="#leaspy-s-data-container" title="Permalink to this headline">Â¶</a></h3>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> <em>Leaspy</em> comes with its own data containers. The one used in a daily basis is <code class="docutils literal notranslate"><span class="pre">Data</span></code>. You can load your data from a csv with it <code class="docutils literal notranslate"><span class="pre">Data.from_csv_file</span></code> or from a DataFrame <code class="docutils literal notranslate"><span class="pre">Data.from_dataframe</span></code>.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 6 ğŸ’¬</span> Run the following lines to convert DataFrame into Data object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_train</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df_train</span><span class="p">)</span>
<span class="n">data_test</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">df_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="part-ii-instantiate-a-leaspy-object">
<h2>Part II : Instantiate a <code class="docutils literal notranslate"><span class="pre">Leaspy</span></code> object<a class="headerlink" href="#part-ii-instantiate-a-leaspy-object" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Before creating a leaspy object, you need to choose the type of progression shape you want to give to your data. The available models are the following:</p>
<ul class="simple">
<li><p>linear</p></li>
<li><p>logistic</p></li>
</ul>
<p>with the possibility to enforce a <em>parallelism</em> between the features. <strong><em>Parallelism</em></strong> imposes that all the features have the same average pace of progression.</p>
<p>Once that is done, you just have to call <code class="docutils literal notranslate"><span class="pre">Leaspy('model_name')</span></code>. The dedicated names are  :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">univariate_linear</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">linear</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">univariate_logistic</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logistic</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">logistic_parallel</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lme_model</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">constant_model</span></code></p></li>
</ul>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 7 ğŸ’¬</span> We choose a logistic model. Run the following line to instantiate the leaspy object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaspy</span> <span class="o">=</span> <span class="n">Leaspy</span><span class="p">(</span><span class="s2">&quot;logistic&quot;</span><span class="p">,</span> <span class="n">source_dimension</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> <code class="docutils literal notranslate"><span class="pre">Leaspy</span></code> object contains all the main methods provided by the software. With this object, you can:</p>
<ul class="simple">
<li><p><strong>calibrate</strong> a model</p></li>
<li><p><strong>personalize</strong> a model to individual data (basically you infer the random effects with a gradient descent)</p></li>
<li><p><strong>estimate</strong> the features values of subjects at given ages based on your calibrated model and their individual parameters</p></li>
<li><p><strong>simulate</strong> synthetic subjects base on your calibrated model, a collection of individual parameters and data</p></li>
<li><p><strong>load</strong> and <strong>save</strong> a model</p></li>
</ul>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 8 ğŸ’¬</span> Check it out by running the following line</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">?</span> Leaspy
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 9 ğŸ’¬</span> This <code class="docutils literal notranslate"><span class="pre">Leaspy</span></code> object comes with an handy attribute for vizualization. Letâ€™s have a look on the data that will be used to calibrate our model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaspy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dimension</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">patient_observations</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_18_0.png" src="../../../_images/TP2_leaspy_beginner_18_0.png" />
</div>
</div>
<p>Wellâ€¦ not so engaging, right? Letâ€™s see what Leaspy can do for you.</p>
</div>
<div class="section" id="part-iii-choose-your-algorithms">
<h2>Part III : Choose your algorithms<a class="headerlink" href="#part-iii-choose-your-algorithms" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Once you choosed your model, you need to choose an algorithm to calibrate it.</p>
<p>To run any algorithm, you need to specify the settings of the related algorithm thanks to the <code class="docutils literal notranslate"><span class="pre">AlgorithmSettings</span></code> object. To ease Leaspyâ€™s usage for new users, we specified default values for each algorithm. Therefore, the name of the algorithm used is enough to run it. The one you need to fit your progression model is <code class="docutils literal notranslate"><span class="pre">mcmc_saem</span></code>, which stands for <a href="https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo" target="_blank">Markov chain Monte Carlo</a> - Stochastic Approximation of <a href="https://en.wikipedia.org/wiki/Expectation%E2%80%93maximization_algorithm" target="_blank">Expectation Maximization</a>.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 10 ğŸ’¬</span> Run the following line to instanciate a <code class="docutils literal notranslate"><span class="pre">AlgorithmSettings</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">algo_settings</span> <span class="o">=</span> <span class="n">AlgorithmSettings</span><span class="p">(</span><span class="s1">&#39;mcmc_saem&#39;</span><span class="p">,</span> 
                                  <span class="n">n_iter</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span>           <span class="c1"># n_iter defines the number of iterations</span>
                                  <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;MSE_diag_noise&#39;</span><span class="p">,</span> <span class="c1"># estimate the residual noise scaling per feature</span>
                                  <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>     <span class="c1"># To display a nice progression bar during calibration</span>
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> You can specify many more settings that are left by default for now. You can also save and load an <code class="docutils literal notranslate"><span class="pre">AlgorithmSettings</span></code> object in a json file.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 11 ğŸ’¬</span> Run the following line to get more informations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">?</span> AlgorithmSettings
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> It is often usefull, even if it is optional to store the different logs of the model during the iterations. You can use the following method with the path of the folder where the logs will be stored.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 12 ğŸ’¬</span> Run the following lines.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">algo_settings</span><span class="o">.</span><span class="n">set_logs</span><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span>          <span class="c1"># Creates a logs file ; if existing, ask if rewrite it</span>
    <span class="n">plot_periodicity</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="c1"># Saves the values to display in pdf every 50 iterations</span>
    <span class="n">save_periodicity</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># Saves the values in csv files every 10 iterations</span>
    <span class="n">console_print_periodicity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># If = N, it display logs in the console/terminal every N iterations</span>
    <span class="n">overwrite_logs_folder</span><span class="o">=</span><span class="kc">True</span>       <span class="c1"># Default behaviour raise an error if the folder already exists.</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...overwrite logs folder...
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="part-iv-fit-your-model">
<h2>Part IV : Fit your model<a class="headerlink" href="#part-iv-fit-your-model" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 13 ğŸ’¬</span> Run the following lines to fit the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaspy</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span> <span class="n">algorithm_settings</span><span class="o">=</span><span class="n">algo_settings</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>|##################################################|   3000/3000 iterations
The standard deviation of the noise at the end of the calibration is:
MDS1_total: 0.0512
MDS2_total: 0.0543
MDS3_off_total: 0.0647

Calibration took: 4min 2s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#y_ij = f(model) + epsilon, epsilon ~ N(0, \sigma)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ #</span>
<span class="c1"># â€“â€“â€“â€“ Answer â€“â€“â€“â€“ #</span>
<span class="c1"># â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ #</span>

<span class="n">leaspy</span> <span class="o">=</span> <span class="n">Leaspy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;outputs/model_parameters.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> This might take several minutes, so letâ€™s discuss about the <em>keyword argument</em> <code class="docutils literal notranslate"><span class="pre">source_dimension</span></code>. This parameters depend on the number of variable you want the model to learn: it can go from 1 to the number of variables. If it is not set by the user the default value is <span class="math notranslate nohighlight">\(\sqrt{N_{features}}\)</span> as it has been shown empirically to give good results. You will learn more about the mathematical formulation of the model below (part V).</p>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Before assuming that the model is estimated, you have to check that the convergence went well. For that, you can look  the at the convergence during the iterations. To do so, you can explore the <code class="docutils literal notranslate"><span class="pre">logs</span></code> folder (in the same folder than this jupyter notebook) that shows the model convergence during the iterations. The first thing to look at is probably the <code class="docutils literal notranslate"><span class="pre">plots/convergence_1.pdf</span></code> and <code class="docutils literal notranslate"><span class="pre">plots/convergence_2.pdf</span></code> files : a run has had enough iterations to converge if the last 20 or even 30% of the iterations were stable for all the parameters. If not, you should provably re-run it with more iterations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">IFrame</span>
<span class="n">IFrame</span><span class="p">(</span><span class="s1">&#39;./logs/plots/convergence_2.pdf&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">670</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<iframe
    width="990"
    height="670"
    src="./logs/plots/convergence_2.pdf"
    frameborder="0"
    allowfullscreen
></iframe>
</div></div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 14 ğŸ’¬</span> <strong>Check out the parameters of the model that are stored here</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaspy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;g&#39;: tensor([2.4051, 2.4871, 1.6007]),
 &#39;v0&#39;: tensor([-5.3408, -5.1878, -5.1113]),
 &#39;betas&#39;: tensor([[-0.0364,  0.0244],
         [ 0.0156,  0.0148]]),
 &#39;tau_mean&#39;: tensor(56.5587),
 &#39;tau_std&#39;: tensor(10.2532),
 &#39;xi_mean&#39;: tensor(0.),
 &#39;xi_std&#39;: tensor(0.6619),
 &#39;sources_mean&#39;: tensor(0.),
 &#39;sources_std&#39;: tensor(1.),
 &#39;noise_std&#39;: tensor([0.0513, 0.0548, 0.0656])}
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span>  Parameters are probably not straightfoward for now. The most important one is probably <code class="docutils literal notranslate"><span class="pre">noise_std</span></code>. It corresponds to the standard deviation of the Gaussian errors (one per feature). The smallest, the better - up to the lower bound which is the intrinsic noise in the data. Note that usually, cognitive measurements have an intrinsic error (computed on test-retest exams) between 5% and 10%.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 15 ğŸ’¬</span> Letâ€™s display <code class="docutils literal notranslate"><span class="pre">noise_std</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">noise</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;noise_std&#39;</span><span class="p">]</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">features</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Standard deviation of the residual noise for the feature:&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">n</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Standard deviation of the residual noise for the feature:
- MDS1_total: 5.12%
- MDS2_total: 5.43%
- MDS3_off_total: 6.47%
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 16 ğŸ’¬</span> Save the model with the command below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaspy</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;outputs/model_parameters.json&quot;</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 17 ğŸ’¬</span> Load the model with the command below</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">leaspy</span> <span class="o">=</span> <span class="n">Leaspy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;outputs/model_parameters.json&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Now that we have sufficient evidence that the model has converged, letâ€™s output what the average progression looks like!</p>
<p>First, letâ€™s detail a bit what we are going to represent. We are going to display a trajectory: it corresponds to the temporal progression of the biomarkers. There is not only one trajectory for a cohort, as each subject has his or her own specific trajectory, meaning his or her disease progression. Each of these individual trajectories rely on individual parameters that are subject-specific. We will see those individual parameters a bit later, do not worry. For now, letâ€™s stick to the <em>average</em> trajectory.</p>
<p>So what does the average trajectory corresponds to? The average trajectory correspond to a <em>virtual patient</em> whose individual parameters are the average individual parameters. And these averages are already estimated during the calibration.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 18 ğŸ’¬</span> Letâ€™s plot the average trajectory</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">average_trajectory</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_42_0.png" src="../../../_images/TP2_leaspy_beginner_42_0.png" />
</div>
</div>
</div>
<div class="section" id="part-v-personalize-the-model-to-individual-data">
<h2>Part V : Personalize the model to individual data<a class="headerlink" href="#part-v-personalize-the-model-to-individual-data" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> The personalization procedure allows to estimate the individual parameters that allows to modify the average progression to individual observations. The variations from the average trajectory to the individual one are encoded within three individual parameters :</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\alpha_i = \exp(\xi_i)\)</span> : the acceleration factor, that modulates the speed of progression : <span class="math notranslate nohighlight">\(\alpha_i &gt; 1\)</span> means faster, <span class="math notranslate nohighlight">\(\alpha_i &lt; 1\)</span> means slower than the average progression</p></li>
<li><p><span class="math notranslate nohighlight">\(\tau_i\)</span> : the time shift which delays the progression in a given number of years. It has to be compared to  <code class="docutils literal notranslate"><span class="pre">tau_mean</span></code> <span class="math notranslate nohighlight">\( = \bar{\tau} \)</span>  which is in the model parameters above. In fact, <span class="math notranslate nohighlight">\( \tau_i \sim \mathcal{N}( \bar{\tau}, \sigma_{\tau}^2)\)</span> , so <span class="math notranslate nohighlight">\(\tau_i &gt; \bar{\tau}\)</span> means that the patient has a disease that starts later than average, while <span class="math notranslate nohighlight">\(\tau_i &lt; \bar{\tau}\)</span> means that the patient has a disease that starts earlier than average</p></li>
<li><p><span class="math notranslate nohighlight">\(w_i = (w_1, ..., w_N)\)</span> (<span class="math notranslate nohighlight">\(N\)</span> being the number of features) : the space-shift  which might, for a given individual, change the ordering of the conversion of the different features, compared to the mean trajectory.</p></li>
</ul>
<p>In a nutshell, the <span class="math notranslate nohighlight">\(k\)</span>-th feature at the <span class="math notranslate nohighlight">\(j\)</span>-th visit of subject <span class="math notranslate nohighlight">\(i\)</span>, which occurs at time <span class="math notranslate nohighlight">\(t_{ij}\)</span> writes:</p>
<div class="math notranslate nohighlight">
\[y_{ijk} = f_\theta ( w_{ik}+ \exp(\xi_i) * (t_{ij} - \tau_i) ) + \epsilon_{ijk}\]</div>
<p>With:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\theta\)</span> being the population parameters, infered during calibration of the model,</p></li>
<li><p><span class="math notranslate nohighlight">\(f_\nu\)</span> a parametric family of trajectories depending of model type,</p></li>
<li><p><span class="math notranslate nohighlight">\(\epsilon_{ijk}\)</span> an independent normally distributed error term.</p></li>
</ul>
<p>This writing is not exactly correct but helps understand the role of each individual parameters.</p>
<p><strong>[ Advanced ]</strong> Remember the <code class="docutils literal notranslate"><span class="pre">sources</span></code>, or the <code class="docutils literal notranslate"><span class="pre">source_dimension</span></code>? Well, <span class="math notranslate nohighlight">\(w_i\)</span> is not estimated directly, but rather thanks to a Independant Component Analysis, such that <span class="math notranslate nohighlight">\(w_i = A s_i\)</span> where <span class="math notranslate nohighlight">\(s_i\)</span> is of dimension <span class="math notranslate nohighlight">\(N_s\)</span> = <code class="docutils literal notranslate"><span class="pre">source_dimension</span></code>. See associated papers for further details.</p>
<p>Now, letâ€™s estimate these individual parameters. The procedure relies on the <code class="docutils literal notranslate"><span class="pre">scipy_minimize</span></code> algorithm (gradient descent) that you have to define (or to load from an appropriate json file) :</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 19 ğŸ’¬</span> First set the parameters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">settings_personalization</span> <span class="o">=</span> <span class="n">AlgorithmSettings</span><span class="p">(</span><span class="s1">&#39;scipy_minimize&#39;</span><span class="p">,</span> <span class="n">progress_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_jacobian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 20 ğŸ’¬</span> Then use the second most important function of leaspy : <code class="docutils literal notranslate"><span class="pre">leaspy.personalize</span></code>. It estimates the individual parameters for the data you provide:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">?</span>leaspy.personalize
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">personalize</span><span class="p">(</span><span class="n">data_test</span><span class="p">,</span> <span class="n">settings_personalization</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>|########################################|   40/40 subjects
The standard deviation of the noise at the end of the personalization is:
MDS1_total: 0.0467
MDS2_total: 0.0493
MDS3_off_total: 0.0580

Personalization scipy_minimize took: 1s
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Note here that you can personalize your model on patients that have only one visit! And you donâ€™t have to use the same <code class="docutils literal notranslate"><span class="pre">data</span></code> as previously. It is especially useful, and important, in order to validate your model!</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 20b ğŸ’¬</span> Once the personalization is done, check the different functions that the <code class="docutils literal notranslate"><span class="pre">IndividualParameters</span></code> provides (you can save and load them, transform them to dataframes, etc) :</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">?</span>ip
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 21 ğŸ’¬</span> Plot the test data, but with reparametrized ages instead of real ages</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the test data with individually reparametrized ages</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">patient_observations_reparametrized</span><span class="p">(</span><span class="n">data_test</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> 
                                                         <span class="n">alpha</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
                                                         <span class="c1">#patients_idx=list(data_test.individuals.keys())[:4],</span>
                                                         <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_52_0.png" src="../../../_images/TP2_leaspy_beginner_52_0.png" />
</div>
</div>
<p>Remember the raw plotting of values during question 9? Better, no?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the test data with individually with true ages</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">patient_observations</span><span class="p">(</span><span class="n">data_test</span><span class="p">,</span>
                                          <span class="n">alpha</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
                                          <span class="c1">#patients_idx=list(data_test.individuals.keys())[:4],</span>
                                          <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_54_0.png" src="../../../_images/TP2_leaspy_beginner_54_0.png" />
</div>
</div>
<p>Now, letâ€™s see what you can do with the individual parameters.</p>
</div>
<div class="section" id="part-vi-impute-missing-values-predict-individual-trajectories">
<h2>Part VI : Impute missing values &amp; predict individual trajectories<a class="headerlink" href="#part-vi-impute-missing-values-predict-individual-trajectories" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Together with the population parameters, the individual parameters entirely defines the individual trajectory, and thus, the biomarker values at any time. So you can reconstruct the individual biomarkers at different ages.</p>
<p>You can reconstruct your observations at seen ages, i.e. at visits that have been used to personalize the model. There are two reasons you might want to do that:</p>
<ul class="simple">
<li><p>see how well the model fitted individual data</p></li>
<li><p>impute missing values: as Leaspy handles missing values, it can then reconstruct them (note that this reconstruction will be noiseless)</p></li>
</ul>
<p>The third very important function - after <code class="docutils literal notranslate"><span class="pre">leaspy.fit</span></code> and <code class="docutils literal notranslate"><span class="pre">leaspy.personalize</span></code> - is <code class="docutils literal notranslate"><span class="pre">leaspy.estimate</span></code>. Given some individual parameters and timepoints, the function estimates the values of the biomarkers at the given timepoints which derive from the individual trajectory encoded thanks to the individual parameters.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 22 ğŸ’¬</span> Check out the documentation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">?</span>leaspy.estimate
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 23 ğŸ’¬</span> Before running <code class="docutils literal notranslate"><span class="pre">leaspy.estimate</span></code>, letâ€™s first retrieve the observations of subject â€˜GS-187â€™ in the initial dataset. Get also his/her individual parameters as shown here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">observations</span> <span class="o">=</span> <span class="n">df_test</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;GS-187&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Seen ages: </span><span class="si">{</span><span class="n">observations</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Individual Parameters : &quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">[</span><span class="s1">&#39;GS-187&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Seen ages: [61.34811783 62.34811783 63.84811783 64.34812164 67.84812164 68.34812164
 69.34812164 69.84812164 70.84812164 71.34812164 71.84812164 72.34812164
 72.84812164 73.34812164]
Individual Parameters :  {&#39;xi&#39;: -0.03377921134233475, &#39;tau&#39;: 76.7496566772461, &#39;sources&#39;: [-1.2913795709609985, 0.507883608341217]}
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> The <code class="docutils literal notranslate"><span class="pre">estimate</span></code> first argument is a dictionary, so that you can estimate the trajectory of multiple individuals simultaneously (as long as the individual parameters of all your queried patients are in <code class="docutils literal notranslate"><span class="pre">ip</span></code>.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 24 ğŸ’¬</span> Now, letâ€™s estimate the trajectory for this patient.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">reconstruction</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">estimate</span><span class="p">({</span><span class="s1">&#39;GS-187&#39;</span><span class="p">:</span> <span class="n">timepoints</span><span class="p">},</span> <span class="n">ip</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_trajectory</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">,</span> <span class="n">observations</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">observations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ages</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">.</span><span class="mi">75</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Biomarker normalized value&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Patient age&#39;</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#003f5c&#39;</span><span class="p">,</span> <span class="s1">&#39;#7a5195&#39;</span><span class="p">,</span> <span class="s1">&#39;#ef5675&#39;</span><span class="p">,</span> <span class="s1">&#39;#ffa600&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">reconstruction</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">observations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="n">observations</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                                
<span class="n">plot_trajectory</span><span class="p">(</span><span class="n">timepoints</span><span class="p">,</span> <span class="n">reconstruction</span><span class="p">[</span><span class="s1">&#39;GS-187&#39;</span><span class="p">],</span> <span class="n">observations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/Cellar/graph-tool/2.35/libexec/lib/python3.8/site-packages/matplotlib/cbook/__init__.py:1402: FutureWarning: Support for multi-dimensional indexing (e.g. `obj[:, None]`) is deprecated and will be removed in a future version.  Convert to a numpy array before indexing instead.
  x[:, None]
/usr/local/Cellar/graph-tool/2.35/libexec/lib/python3.8/site-packages/matplotlib/axes/_base.py:278: FutureWarning: Support for multi-dimensional indexing (e.g. `obj[:, None]`) is deprecated and will be removed in a future version.  Convert to a numpy array before indexing instead.
  y = y[:, np.newaxis]
</pre></div>
</div>
<img alt="../../../_images/TP2_leaspy_beginner_60_1.png" src="../../../_images/TP2_leaspy_beginner_60_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Or with plotting object</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">patient_trajectories</span><span class="p">(</span><span class="n">data_test</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
                                          <span class="n">patients_idx</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GS-187&#39;</span><span class="p">,</span><span class="s1">&#39;GS-180&#39;</span><span class="p">],</span>
                                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MDS1&#39;</span><span class="p">,</span><span class="s1">&#39;MDS2&#39;</span><span class="p">,</span> <span class="s1">&#39;MDS3 (off)&#39;</span><span class="p">],</span>
                                          <span class="c1">#reparametrized_ages=True, # check sources effect</span>
                                          
                                          <span class="c1"># plot kwargs</span>
                                          <span class="c1">#color=[&#39;#003f5c&#39;, &#39;#7a5195&#39;, &#39;#ef5675&#39;, &#39;#ffa600&#39;],</span>
                                          <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                          <span class="c1">#marker=None,</span>
                                          <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">obs_alpha</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="c1">#obs_ls=&#39;:&#39;, </span>
                                          <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                                          <span class="n">factor_past</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span>
                                          <span class="n">factor_future</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="c1"># future extrapolation</span>
                                          <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="c1">#ax.set_ylim(0, .75)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_61_0.png" src="../../../_images/TP2_leaspy_beginner_61_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grasp source effects</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">patient_trajectories</span><span class="p">(</span><span class="n">data_test</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span>
                                          <span class="n">patients_idx</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MDS1&#39;</span><span class="p">,</span><span class="s1">&#39;MDS2&#39;</span><span class="p">,</span> <span class="s1">&#39;MDS3 (off)&#39;</span><span class="p">],</span>
                                          <span class="n">reparametrized_ages</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># check sources effect</span>
                                          
                                          <span class="c1"># plot kwargs</span>
                                          <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
                                          <span class="n">factor_past</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                          <span class="n">factor_future</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># no extrapolation (future) nor past</span>
                                          <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="c1">#ax.set_ylim(0, .75)</span>
<span class="c1">#ax.set_xlim(45, 120)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_62_0.png" src="../../../_images/TP2_leaspy_beginner_62_0.png" />
</div>
</div>
</div>
<div class="section" id="part-vii-leaspy-application-cofactor-analysis">
<h2>Part VII : Leaspy application - Cofactor analysis<a class="headerlink" href="#part-vii-leaspy-application-cofactor-analysis" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Besides prediction, the individual parameters are interesting in the sense that they provide meaningful and interesting insights about the disease progression. For that reason, these individual parameters can be correlated to other cofactors. Letâ€™s consider that you have a covariate <em>Cofactor 1</em> that encodes a genetic status: 1 if a specific mutation is present, 0 otherwise.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 25 ğŸ’¬</span> Now, letâ€™s see if this mutation has an effect on the disease progression:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># â€”â€” Convert individual parameters to dataframe</span>
<span class="n">df_ip</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

<span class="c1"># â€”â€” Join the cofactors to individual parameters</span>
<span class="n">cofactor</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s2">&quot;cof_leaspy1.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">])</span>
<span class="n">df_ip</span> <span class="o">=</span> <span class="n">df_ip</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cofactor</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;MUTATION&#39;</span><span class="p">:{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Non-carrier&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Carrier&#39;</span><span class="p">}}))</span>

<span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># â€”â€” Plot the time shifts in carriers and non-carriers</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time shift histogram&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_ip</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;MUTATION&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># â€”â€” Plot the acceleration factor in carriers and non-carriers</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Log-Acceleration factor histogram&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_ip</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;MUTATION&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># __ Joint density (tau, xi) __</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_ip</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;tau&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;xi&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;MUTATION&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">bw_adjust</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">ax_joint</span><span class="o">.</span><span class="n">grid</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_64_0.png" src="../../../_images/TP2_leaspy_beginner_64_0.png" />
<img alt="../../../_images/TP2_leaspy_beginner_64_1.png" src="../../../_images/TP2_leaspy_beginner_64_1.png" />
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 26 ğŸ’¬</span> <strong>Now, check your hypothesis with statistical tests</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Shortcuts of df_ip for 2 sub-populationscarriers = df_ip[df_ip[&#39;MUTATION&#39;] == &#39;Carrier&#39;]non_carriers = df_ip[df_ip[&#39;MUTATION&#39;] == &#39;Non-carrier&#39;]</span>
<span class="c1"># â€”â€” Student t-test (under the asumption of a gaussian distribution only)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">carriers</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span> <span class="n">non_carriers</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">carriers</span><span class="p">[</span><span class="s1">&#39;xi&#39;</span><span class="p">],</span> <span class="n">non_carriers</span><span class="p">[</span><span class="s1">&#39;xi&#39;</span><span class="p">]))</span>

<span class="c1"># â€”â€” Mann-withney t-test</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">carriers</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">],</span> <span class="n">non_carriers</span><span class="p">[</span><span class="s1">&#39;tau&#39;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">carriers</span><span class="p">[</span><span class="s1">&#39;xi&#39;</span><span class="p">],</span> <span class="n">non_carriers</span><span class="p">[</span><span class="s1">&#39;xi&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ttest_indResult(statistic=-0.9757572384196719, pvalue=0.3353558736353631)
Ttest_indResult(statistic=3.7526560503249073, pvalue=0.0005838617062167643)
MannwhitneyuResult(statistic=150.0, pvalue=0.15064363240193013)
MannwhitneyuResult(statistic=48.0, pvalue=5.152999045364206e-05)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="part-viii-data-simulation">
<h2>Part VIII : Data Simulation<a class="headerlink" href="#part-viii-data-simulation" title="Permalink to this headline">Â¶</a></h2>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> Now that you are able to predict the evolution of a patient and use it to analyse cofactors, you might want to simulate a new one thanks to the information that you have learned. To do so you can use the last method of leaspy that we will study : <code class="docutils literal notranslate"><span class="pre">simulate</span></code>.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 27 ğŸ’¬</span> Have a look to the function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">?</span>leaspy.simulate
</pre></div>
</div>
</div>
</div>
<p><span style='color: #015e75; font-weight: 600;'>â„¹ï¸ Information â„¹ï¸</span> To use the fuction we will first extract the individual parameters using personalize with <code class="docutils literal notranslate"><span class="pre">mode_real</span></code> option. The simulate function learns the joined distribution of the individual parameters and baseline age of the subjects
present in <code class="docutils literal notranslate"><span class="pre">individual_parameters</span></code> and <code class="docutils literal notranslate"><span class="pre">data</span></code> respectively to sample new patients from this joined distribution.</p>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 28 ğŸ’¬</span> Define the settings for the personalization and get the individual parameters</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">settings_ip_simulate</span> <span class="o">=</span> <span class="n">AlgorithmSettings</span><span class="p">(</span><span class="s1">&#39;mode_real&#39;</span><span class="p">)</span>
<span class="n">individual_params</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">personalize</span><span class="p">(</span><span class="n">data_test</span><span class="p">,</span> <span class="n">settings_ip_simulate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The standard deviation of the noise at the end of the personalization is:
MDS1_total: 0.0469
MDS2_total: 0.0494
MDS3_off_total: 0.0599

Personalization mode_real took: 5s
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 29 ğŸ’¬</span> Define your algorithm for the simulation and simulate individuals from previously obtained individual parameters and dataset</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">settings_simulate</span> <span class="o">=</span> <span class="n">AlgorithmSettings</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
<span class="n">simulated_data</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">individual_params</span><span class="p">,</span> <span class="n">data_test</span><span class="p">,</span> <span class="n">settings_simulate</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 30 ğŸ’¬</span> Access to the individual parameters of one individual that you have created</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">simulated_data</span><span class="o">.</span><span class="n">get_patient_individual_parameters</span><span class="p">(</span><span class="s2">&quot;Generated_subject_001&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;tau&#39;: tensor([56.2327], dtype=torch.float64), &#39;xi&#39;: tensor([0.8927], dtype=torch.float64), &#39;sources&#39;: tensor([0.0626, 1.8273], dtype=torch.float64)}
</pre></div>
</div>
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 31 ğŸ’¬</span> Plot the joint distribution of individual parameters (tau, xi) for simulated individuals that you have created</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a dataframe with individual parameters from both real &amp; simulated individuals</span>
<span class="n">df_ip_both</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span>
    <span class="s1">&#39;estimated&#39;</span><span class="p">:</span> <span class="n">individual_params</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span>
    <span class="s1">&#39;simulated&#39;</span><span class="p">:</span> <span class="n">simulated_data</span><span class="o">.</span><span class="n">get_dataframe_individual_parameters</span><span class="p">()</span>
<span class="p">},</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Origin&#39;</span><span class="p">])</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">jointplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_ip_both</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                  <span class="n">marginal_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">common_norm</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">g</span><span class="o">.</span><span class="n">plot_joint</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">bw_adjust</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">ax_joint</span><span class="o">.</span><span class="n">grid</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_76_0.png" src="../../../_images/TP2_leaspy_beginner_76_0.png" />
</div>
</div>
<p><span style='color: #a13203; font-weight: 600;'>ğŸ’¬ Question 32 ğŸ’¬</span> <strong>Plot some simulated individual trajectories</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">leaspy</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">patient_observations</span><span class="p">(</span><span class="n">simulated_data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">7</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                          <span class="n">patients_idx</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Generated_subject_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">03</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">42</span><span class="p">]])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/TP2_leaspy_beginner_78_0.png" src="../../../_images/TP2_leaspy_beginner_78_0.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./pages/notebooks/leaspy"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="TP1_LMM.html" title="previous page">Linear Mixed-effects Models</a>
    <a class='right-next' id="next-link" href="TP3_advanced_leaspy.html" title="next page">Advanced Leaspy Utilisation</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The Disease Progression Modelling community<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>